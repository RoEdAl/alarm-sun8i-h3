# U-Boot: sunXi (OrangePi/NanoPi)

pkgbase='uboot-sunxi-dto'
pkgname=('uboot-orangepi-zero' 'uboot-nanopi-neo' 'uboot-a10-olinuxino-lime-dto' 'uboot-a20-olinuxino-lime-dto')
pkgver=2018.03
pkgrel=1
arch=('armv7h')
_baserel=62ceb441bfe96eba0aa467c07516df8c5947aeeb
url='http://git.denx.de/u-boot.git/'
license=('GPL')
makedepends=('bc' 'python2' 'swig' 'dtc')
backup=(
	'boot/boot.txt'
	'boot/boot.scr')

source=("ftp://ftp.denx.de/pub/u-boot/u-boot-${pkgver}.tar.bz2"
	'boot.txt'
	'flash-uboot.sh'
	'config-fragment'
	"http://raw.githubusercontent.com/archlinuxarm/PKGBUILDs/${_baserel}/alarm/uboot-sunxi/mkscr"
	'orangepi_zero_defconfig'
	'nanopi_neo_defconfig'
	'A10-OLinuXino-Lime_defconfig'
	'A20-OLinuXino-Lime_defconfig')
sha1sums=('2714c06270bd164e5420f8beba0da2354f7bc695'
          '033b7eb4ab939d92e5eee94d2a9290b92b830955'
          'a49a8c18e1b0f920a430cf57990c0c42dc864f59'
          '41bbf43f35b4cb41a2ea4bcf18d0f6bb75819c40'
          '008b9ce4fcf64c939868148ca387fa733c8b7e69'
          'bdbd3278a4b5ec7433e2a7eadd463d0c917b8e5b'
          'ff107815cdab116b669f35bd7419622395379eea'
          'd7b65ca0d37be5b690ee9788d43702e5d4d4d008'
          '09d684946e85614fcf41c9ecebd5cdf1ff1a12a0')

boards=('orangepi_zero' 'nanopi_neo' 'A10-OLinuXino-Lime' 'A20-OLinuXino-Lime')

prepare() {
  cd u-boot-${pkgver}

  cp ${srcdir}/orangepi_zero_defconfig configs
  cp arch/arm/dts/sun8i-h2-plus-orangepi-zero.dts arch/arm/dts/sun8i-h2-plus-orangepi-zero_.dts

  cp ${srcdir}/nanopi_neo_defconfig configs
  cp arch/arm/dts/sun8i-h3-nanopi-neo.dts arch/arm/dts/sun8i-h3-nanopi-neo_.dts

  cp ${srcdir}/A10-OLinuXino-Lime_defconfig configs
  cp arch/arm/dts/sun4i-a10-olinuxino-lime.dts arch/arm/dts/sun4i-a10-olinuxino-lime_.dts

  cp ${srcdir}/A20-OLinuXino-Lime_defconfig configs
  cp arch/arm/dts/sun7i-a20-olinuxino-lime.dts arch/arm/dts/sun7i-a20-olinuxino-lime_.dts
}

build() {
  cd u-boot-${pkgver}

  unset CFLAGS CXXFLAGS LDFLAGS

  for i in ${boards[@]}; do
    mkdir ../bin_${i} || true
    make distclean
    make ${i}_config
    scripts/kconfig/merge_config.sh .config ${srcdir}/config-fragment
    make EXTRAVERSION=-${pkgrel} PYTHON=python2 V=0
    mv u-boot-sunxi-with-spl.bin ../bin_${i}
  done

  tools/mkimage -A arm -O linux -T script -C none -n "U-Boot boot script" -d ../boot.txt ../boot.scr
}

package_uboot-orangepi-zero() {
  pkgdesc='U-Boot for Orange Pi Zero (with device tree overlays support)'
  install=${pkgbase}.install
  provides=('uboot-sunxi')
  conflicts=('uboot-sunxi')
  depends=('orangepi-dtbs')
  optdepends=('uboot-tools' 'sun8i-h3-dt-overlays')

  install -d "${pkgdir}/boot"
  install -Dm644 bin_orangepi_zero/u-boot-sunxi-with-spl.bin "${pkgdir}/boot"

  install -Dm644 boot.txt "${pkgdir}/boot/boot.txt"
  install -Dm644 boot.scr "${pkgdir}/boot/boot.scr"
  install -Dm755 mkscr "${pkgdir}/boot/mkscr"
  install -Dm755 flash-uboot.sh "${pkgdir}/boot/flash-uboot"
}

package_uboot-nanopi-neo() {
  pkgdesc='U-Boot for NanoPi Neo (with device tree overlays support)'
  install=${pkgbase}.install
  provides=('uboot-sunxi')
  conflicts=('uboot-sunxi')
  depends=('nanopi-dtbs')
  optdepends=('uboot-tools' 'sun8i-h3-dt-overlays')

  install -d "${pkgdir}/boot"
  install -Dm644 bin_nanopi_neo/u-boot-sunxi-with-spl.bin "${pkgdir}/boot"

  install -Dm644 boot.txt "${pkgdir}/boot/boot.txt"
  install -Dm644 boot.scr "${pkgdir}/boot/boot.scr"
  install -Dm755 mkscr "${pkgdir}/boot/mkscr"
  install -Dm755 flash-uboot.sh "${pkgdir}/boot/flash-uboot"
}

package_uboot-a10-olinuxino-lime-dto() {
  pkgdesc='U-Boot for A10 OLinuXino Lime (with device tree overlays support)'
  install=${pkgbase}.install
  provides=('uboot-sunxi')
  conflicts=('uboot-sunxi')
  depends=('olinuxino-lime-dtbs')
  optdepends=('uboot-tools' 'sun4i-a10-dt-overlays')

  install -d "${pkgdir}/boot"
  install -Dm644 bin_A10-OLinuXino-Lime/u-boot-sunxi-with-spl.bin "${pkgdir}/boot"

  install -Dm644 boot.txt "${pkgdir}/boot/boot.txt"
  install -Dm644 boot.scr "${pkgdir}/boot/boot.scr"
  install -Dm755 mkscr "${pkgdir}/boot/mkscr"
  install -Dm755 flash-uboot.sh "${pkgdir}/boot/flash-uboot"
}

package_uboot-a20-olinuxino-lime-dto() {
  pkgdesc='U-Boot for A20 OLinuXino Lime (with device tree overlays support)'
  install=${pkgbase}.install
  provides=('uboot-sunxi')
  conflicts=('uboot-sunxi')
  depends=('olinuxino-lime-dtbs')
  optdepends=('uboot-tools' 'sun7i-a20-dt-overlays')

  install -d "${pkgdir}/boot"
  install -Dm644 bin_A20-OLinuXino-Lime/u-boot-sunxi-with-spl.bin "${pkgdir}/boot"

  install -Dm644 boot.txt "${pkgdir}/boot/boot.txt"
  install -Dm644 boot.scr "${pkgdir}/boot/boot.scr"
  install -Dm755 mkscr "${pkgdir}/boot/mkscr"
  install -Dm755 flash-uboot.sh "${pkgdir}/boot/flash-uboot"
}
